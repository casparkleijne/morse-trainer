name: Godot Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:

  build-ios:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      
      - name: Export iOS
        run: |
          mkdir -p build/ios
          /Applications/Godot.app/Contents/MacOS/Godot --headless --export-release "iOS" ./build/ios/MorseTrainer
      
      - name: Debug - show files
        run: |
          ls -la ./build/
          ls -la ./build/ios/ || echo "ios folder empty or not found"
          find ./build -name "*.xcodeproj" || echo "no xcodeproj found"

      - name: Debug - check secret
        run: |
          echo "Team ID length: ${#TEAM_ID}"
          echo "First 3 chars: ${TEAM_ID:0:3}"
        env:
          TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      
      - name: Set Team ID
        run: |
          cat export_presets.cfg | grep app_store_team_id
          sed -i '' 's/app_store_team_id="[^"]*"/app_store_team_id="${{ secrets.APPLE_TEAM_ID }}"/' export_presets.cfg
          echo "After sed:"
          cat export_presets.cfg | grep app_store_team_id
      
      - name: Set Team ID
        run: |
          sed -i '' 's/app_store_team_id="[^"]*"/app_store_team_id="${{ secrets.APPLE_TEAM_ID }}"/' export_presets.cfg

      
      - name: Build iOS
        run: |
          xcodebuild -project ./build/ios/MorseTrainer.xcodeproj \
                     -scheme MorseTrainer \
                     -sdk iphoneos \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="Apple Development" \
                     CODE_SIGN_STYLE=Automatic \
                     DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
                     archive -archivePath ./build/ios/MorseTrainer.xcarchive
