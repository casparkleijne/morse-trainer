

name: Godot Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-keychain-settings -t 3600 ~/Library/Keychains/login.keychain-db
      
      
      - name: Build macOS
        run: |
          mkdir -p build
          /Applications/Godot.app/Contents/MacOS/Godot --headless --export-release "macOS" ./build/MorseTrainer.zip

  build-ios:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Unlock Keychain
        run: |
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
          security set-keychain-settings -t 3600 ~/Library/Keychains/login.keychain-db
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" ~/Library/Keychains/login.keychain-db
            
      - name: Set Team ID
        run: |
          echo "Before:"
          grep app_store_team_id export_presets.cfg
          sed -i '' 's/app_store_team_id="[^"]*"/app_store_team_id="${{ secrets.APPLE_TEAM_ID }}"/' export_presets.cfg
          echo "After:"
          grep app_store_team_id export_presets.cfg
      
      - name: Export iOS
        run: |
          mkdir -p build/ios
          /Applications/Godot.app/Contents/MacOS/Godot --headless --export-release "iOS" ./build/ios/MorseTrainer
      
      - name: Build iOS
        run: |
          xcodebuild -project ./build/ios/MorseTrainer.xcodeproj \
                     -scheme MorseTrainer \
                     -sdk iphoneos \
                     -configuration Release \
                     CODE_SIGN_IDENTITY="Apple Development" \
                     CODE_SIGN_STYLE=Automatic \
                     DEVELOPMENT_TEAM="${{ secrets.APPLE_TEAM_ID }}" \
                     -allowProvisioningUpdates \
                     archive -archivePath ./build/ios/MorseTrainer.xcarchive


      - name: Create ExportOptions.plist
              run:|
                cat > ExportOptions.plist << EOF
                <?xml version="1.0" encoding="UTF-8"?>
                <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                <plist version="1.0">
                <dict>
                    <key>method</key>
                    <string>development</string>
                    <key>teamID</key>
                    <string>${{ secrets.APPLE_TEAM_ID }}</string>
                    <key>signingStyle</key>
                    <string>automatic</string>
                </dict>
                </plist>
                EOF
      
            - name:Export IPA
              run:|
                xcodebuild -exportArchive \
                  -archivePath ./build/ios/MorseTrainer.xcarchive \
                  -exportPath ./build/ios/export \
                  -exportOptionsPlist ExportOptions.plist \
                  -allowProvisioningUpdates
      
            - name:Upload IPA
              uses:actions/upload-artifact@v4
              with:
                name: MorseTrainer-iOS
                path: ./build/ios/export/*.ipa


                     
